<!DOCTYPE HTML>
<html>
  <head>
    <title>Home - Blog of Ryan Bigg</title>
    <link href="http://feeds.feedburner.com/ryanbigg" rel="alternate" title="The Life of a Radar" type="application/atom+xml" />
    <link href='http://fonts.googleapis.com/css?family=Buenard' rel='stylesheet' type='text/css'>
    <link rel='stylesheet' href='/css/style.css' media='screen'>
    <link rel='stylesheet' href='/css/mobile.css'>
  <body>
    <h1 align='center'>The Life of a Radar</h1>
    <div id='page'>
      <div id="header">
        <p>Hi there, my parents and friends call me Ryan Bigg, but you may know me as "Radar". Either is fine.</p>
        <p>I'm a technical writer for Ruby / Rails based in Australia. I have written a Rails book with <a href="http://yehudakatz.com">Yehuda Katz</a> called <a href="http://manning.com/bigg2">Rails 4 in Action</a>, which is available also on <a href='http://www.amazon.com/Rails-3-Action-Ryan-Bigg/dp/1935182277'>Amazon</a>. I wrote <a href='http://leanpub.com/multi-tenancy-rails'>Multitenancy With Rails</a>, and I'm in the process of writing my third book <a href='http://leanpub.com/debuggingruby'>Debugging Ruby</a>.
        </p>

        <div id="more">
          <p>
          I won a <a href='http://rubyheroes.com'>Ruby Hero</a> award in 2011 for my work on documentation for Rails. I keep some guides in my <a href='http://github.com/radar/guides'>guides</a> repository on GitHub. As part of this documentation, I've worked on the <a href='http://guides.rubyonrails.org/asset_pipeline.html'>Asset Pipeline</a>, <a href='http://guides.rubyonrails.org/active_record_querying.html'>Active Record Query Interface</a>, <a href='http://guides.rubyonrails.org/configuring.html'>Configuring Rails Applications</a>, <a href='http://guides.rubyonrails.org/engines.html'>Getting Started with Engines</a> and the <a href='http://guides.rubyonrails.org/initialization.html'>Rails Initialization Internals</a> guides. I've also been known to hang out on <a href='http://stackoverflow.com/users/15245/ryan-bigg'>Stack Overflow</a>.
          </p>
          <p> Occasionally I find some time to write interesting blog posts such as the ones you see below.</p>
          <p>I also have done quite a lot of <a href="http://github.com/radar">open-source work</a> and I <a href="http://twitter.com/ryanbigg">tweet</a>. Find out more <a href="http://ryanbigg.com/about-me">about me</a>.</p> 
          <p>If you like what you see you can <a href='http://feeds.feedburner.com/ryanbigg'>subscribe to this blog</a>.</p>
          <p>You can also <a href='http://airpair.me/ryanbigg'>pair with me</a>.</p>
        </div>
      </div>
      <header></header>
      

<!-- Layout inspired by Nick Quaranto's "Litany Against Fear" blog 
     http://litanyagainstfear.com -->
<div id='page'>
  <article>
    <a href="/2014/06/spree-factories-and-callbacks"><header>Spree, Factories and Callbacks</header></a>
    <small>17 Jun 2014</small><br>
    <p>During last week, I was trying to wrap my head around Spree&#39;s code again. I continued my efforts yesterday and tweeted this:</p>

<blockquote class="twitter-tweet" lang="en"><p>Realtalk: I think weâ€™ve dug ourselves a nice hole in Spree by relying too much on callbacks + Factory Girl factories.</p>&mdash; The Bigg Man Himself (@ryanbigg) <a href="https://twitter.com/ryanbigg/statuses/478316786576674816">June 15, 2014</a></blockquote>

<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>Some people have asked me to explain what I mean by this, and hopefully I can do that in this blog post. </p>

<p>Spree is a pretty complex chunk of code which has been built up over the past 6 years and it&#39;s always been based off &quot;the Rails way&quot; of doing things. Being a Rails developer myself, I enjoy this because the design of Spree is not dissimilar to any other Rails app that I worked on before coming to work on Spree full time. The models in both Rails apps and Spree itself are in <code>app/models</code>, and the controllers are in <code>app/controllers</code> and so on.</p>

<p>A lot of people have come to disagree with the general way that Rails applications are designed. Just look around the internet and you&#39;ll see talks like <a href="https://www.youtube.com/watch?v=CGN4RFkhH2M&amp;feature=kp">Matt Wynne&#39;s &quot;Hexagonal Rails&quot;</a> and <a href="http://www.confreaks.com/videos/759-rubymidwest2011-keynote-architecture-the-lost-years">Uncle Bob Martin&#39;s &quot;Architecture the Lost Years&quot;</a>.</p>

<p>You would think that I would generally agree with the way Rails apps and Spree are architected, given that I <a href="https://manning.com/bigg2">wrote a book</a> about Rails and I am the <a href="https://github.com/spree/spree/graphs/contributors">#1 committer to Spree</a>.</p>

<p>You&#39;d be <em>mostly</em> right. I&#39;m familiar with it all, and so I like. There&#39;s still a lot to be desired, however.</p>

<p>I&#39;ve come to find the architecture of Rails ties it all too closely together. Take for example <a href="https://gist.github.com/radar/00e321fb4be0c20666aa">this Gist of SQL, generated from when Spree creates a line item from a factory</a>. SQL like this is generated at the top of the test <a href="https://github.com/spree/spree/blob/4687e608b49236c2850500b026a9fbbab37dc96c/core/spec/models/spree/calculator/default_tax_spec.rb">within spec/models/spree/calculator/default<em>tax</em>spec.rb</a>. This SQL is a result of an abuse of factories on one hand, and quite a large amount of callbacks within Spree itself. There is no reason other than convenience that these factories are used; they create all the other &quot;necessary&quot; objects for our test, and sometimes even unnecessary ones. </p>

<p>Just by creating that one line item, the test file has inserted 20 records into the database, and has issued 34 <code>UPDATE</code> commands. I have no clue as to how many of those are required.</p>

<p>Sure, the factories provide some good. For instance, the line item factory creates a variant, which creates a product, and a product has a tax category. From the line item&#39;s variant&#39;s product&#39;s tax category, we can work out how much tax this line item is supposed to incur.</p>

<p>If you look through the code for this spec, there&#39;s not a single place where database persistence is necessary. All this test needs to do is to take some items and, based off the tax rates available, calculate the correct amounts.</p>

<p>Why does this test need to add data to the database and then read it? Couldn&#39;t the whole code of this be done with plain old Ruby objects and the persistence left to something else?</p>

<h2>PORO Spree</h2>

<p>The answer to that is yes. I&#39;ve done just that in my <a href="https://github.com/radar/spree_poro">spree_poro</a> project. I&#39;ve cheated a little by passing around a <code>Spree::Data</code> constant rather than using something more responsible like the Repository Pattern (<a href="https://twitter.com/sj26/status/478462521343348737">hat-tip to @sj26</a>), but the whole idea is there.</p>

<p>Take a look at the <a href="https://github.com/radar/spree_poro/blob/master/spec/spree/tax_rate_spec.rb">TaxRate spec file</a>. Rather than factories, all the information is setup in the test. It&#39;s all Plain Old Ruby Objects. It does nothing with the &quot;database&quot;, other than that <code>Spree::Data</code> cheat I mentioned earlier.</p>

<p>Oh, and it&#39;s fast. It runs 52 examples in 0.08 seconds. From start to finish, I get test feedback in about 1.5 seconds, which perfectly suits my short attention span.</p>

<h2>Callbacks</h2>

<p>Besides the callback hooks that live in <code>Spree::ItemAdjustments</code> that allow people to hook into the adjustment cycle within Spree, there&#39;s no other callbacks within the <code>spree_poro</code> system. It is my honest belief that we should be able to do everything that Spree does already in this small, enclosed system, sans factories and sans callbacks.</p>

<p>Within Spree-proper, there&#39;s a lot of callbacks. Take this chain of events that happens when an adjustment is created from a promotion:</p>

<ol>
<li><a href="https://github.com/spree/spree/blob/4687e608b49236c2850500b026a9fbbab37dc96c/core/app/models/spree/promotion/actions/create_item_adjustments.rb#L32">create_adjustment is called</a>, which instantly persists an Adjustment object to the database.</li>
<li><a href="https://github.com/spree/spree/blob/4687e608b49236c2850500b026a9fbbab37dc96c/core/app/models/spree/adjustment.rb#L42"><code>update_adjustable_adjustment_total</code> is called</a>, which <a href="https://github.com/spree/spree/blob/4687e608b49236c2850500b026a9fbbab37dc96c/core/app/models/spree/adjustment.rb#L101-L104">calls out to one of the POROs already within Spree</a></li>
<li><a href="https://github.com/spree/spree/blob/4687e608b49236c2850500b026a9fbbab37dc96c/core/app/models/spree/item_adjustments.rb#L38-L45">Spree::ItemAdjustments#update_adjustments</a> fetches all the promotional adjustments for the object <em>from the database</em>, and calls <code>Spree::Adjustment#update!</code>.</li>
<li><a href="https://github.com/spree/spree/blob/4687e608b49236c2850500b026a9fbbab37dc96c/core/app/models/spree/adjustment.rb#L84-L97">Spree::Adjustment#update!</a> computes the adjustment&#39;s value based on the source&#39;s (promotion action&#39;s) calculator, and then <em>saves that to the database</em>. If it&#39;s a promotion, it&#39;ll <em>save again</em> by updating the eligibility of the promotion (which is a <a href="https://github.com/spree/spree/blob/4687e608b49236c2850500b026a9fbbab37dc96c/core/app/models/spree/promotion.rb#L72-L75">whole other rabbit hole</a>).</li>
</ol>

<p>I really think this could be all improved by having an <code>Order</code> object in-memory and acting upon that. The <code>Adjustment</code> objects would be on the in-memory <code>Order</code> object now, much like they are in <code>spree_poro</code>. Any changes to that object are persisted back to the database much later on. It&#39;s not the code&#39;s job to care about these changes getting back to the database. It&#39;s the code&#39;s job to perform these calculations and return us a result. Some <em>other</em> code needs to take care of persisting it back to the database.</p>

<p>This is why I think Rails apps are &quot;tied too closely together&quot;. We have the &quot;model&quot; which is this thing which contains <em>both</em> the business logic and the persistence logic. They should&#39;ve been separate concerns from the beginning. Having the one class that can do both things has lead us down this trap.</p>

<p>If I was going to re-architect Spree -- or any large Rails app for that matter -- something like <a href="https://github.com/radar/spree_poro">spree_poro</a> is where I would start. I wouldn&#39;t start with a Rails app, or even a Rails engine. I would start here: in a small repo of code that has tests written before any code, then the code implements the business rules and the tests pass. Refactoring happens then, because otherwise <a href="https://codeclimate.com/github/radar/spree_poro">CodeClimate</a> would say nasty things about the code. The Rails engine can call out to it later.</p>

  </article>
</div>

<div id='archive'>
  <h2>25 back</h2>
  <ul>
    
      <li><a href="/2014/04/community-management">Community Management</a><abbr>02 Apr 2014</abbr></li>
  
      <li><a href="/2013/10/violence-in-the-ruby-community">Violence in the Ruby community</a><abbr>14 Oct 2013</abbr></li>
  
      <li><a href="/2013/09/order-adjustments">Order adjustments within Spree</a><abbr>24 Sep 2013</abbr></li>
  
      <li><a href="/2013/09/debugging-rails-controllers">Debugging Rails Controllers</a><abbr>05 Sep 2013</abbr></li>
  
      <li><a href="/2013/08/bundler-local-paths">Bundler local paths</a><abbr>16 Aug 2013</abbr></li>
  
      <li><a href="/2013/07/waiting-for-ajax-in-capybara">Waiting for AJAX in Capybara</a><abbr>09 Jul 2013</abbr></li>
  
      <li><a href="/2013/06/finding-sql-queries-in-rails">Finding SQL queries in Rails</a><abbr>26 Jun 2013</abbr></li>
  
      <li><a href="/2013/02/about-spec-support">About spec/support</a><abbr>02 Feb 2013</abbr></li>
  
      <li><a href="/2013/01/multitenancy-with-rails">Multitenancy with Rails</a><abbr>21 Jan 2013</abbr></li>
  
      <li><a href="/2013/01/a-story-about-scaffolding">A story about scaffolding</a><abbr>07 Jan 2013</abbr></li>
  
      <li><a href="/2012/11/no-more-writing-for-manning">No more writing for Manning</a><abbr>12 Nov 2012</abbr></li>
  
      <li><a href="/2012/11/i-didn-t-submit-a-talk-to-rubyconf-australia">I didn't submit a talk to RubyConf Australia</a><abbr>01 Nov 2012</abbr></li>
  
      <li><a href="/2012/10/javascript-arrays-and-objects">JavaScript Arrays and Objects</a><abbr>03 Oct 2012</abbr></li>
  
      <li><a href="/2012/05/on-hiring">On Hiring</a><abbr>25 May 2012</abbr></li>
  
      <li><a href="/2012/05/how-not-to-hire-me">How not to hire me</a><abbr>25 May 2012</abbr></li>
  
      <li><a href="/2012/05/engines-talk">Engines talk</a><abbr>19 May 2012</abbr></li>
  
      <li><a href="/2012/04/caffeine-and-sleep">Caffeine and Sleep</a><abbr>27 Apr 2012</abbr></li>
  
      <li><a href="/2012/04/integration-testing-engines">Integration testing engines</a><abbr>26 Apr 2012</abbr></li>
  
      <li><a href="/2012/03/polymorphic-routes">Polymorphic Routes</a><abbr>27 Mar 2012</abbr></li>
  
      <li><a href="/2012/03/please-learn-rails">Please learn Rails</a><abbr>17 Mar 2012</abbr></li>
  
      <li><a href="/2012/03/frontier-we-need-to-talk">Frontier, we need to talk</a><abbr>14 Mar 2012</abbr></li>
  
      <li><a href="/2012/03/engines-and-authentication">Engines and Authentication</a><abbr>03 Mar 2012</abbr></li>
  
      <li><a href="/2012/01/free-help">Free Help</a><abbr>31 Jan 2012</abbr></li>
  
      <li><a href="/2012/01/moving-out-down-to-melbourne">Moving Out: Down to Melbourne</a><abbr>09 Jan 2012</abbr></li>
  
      <li><a href="/2011/12/matt-lightner">Matt Lightner</a><abbr>27 Dec 2011</abbr></li>
  
  </ul>
  <center><a href='/blogography.html'>The Complete Blogography</a></center>
</div>

    </div>
    <script type="text/javascript">
      var _gauges = _gauges || [];
      (function() {
        var t   = document.createElement('script');
        t.type  = 'text/javascript';
        t.async = true;
        t.id    = 'gauges-tracker';
        t.setAttribute('data-site-id', '4e30f771f5a1f547c8000001');
        t.src = '//secure.gaug.es/track.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(t, s);
      })();
    </script>
  </body>
</html>
