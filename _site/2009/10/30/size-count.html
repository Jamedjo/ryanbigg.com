<!DOCTYPE HTML>
<html>
  <head>
    <link rel='stylesheet' href='css/style.css'>
  <body>
    <p>When using a has_many :through in Rails with a counter_cache an interesting thing can occur. When you call <code>size</code> on the association, it can return a seemingly incorrect number. This is caused by the following code in <em>activerecord/lib/has\_many\_through\_association.rb</em>:</p>
<pre>
def size
  return @owner.send(:read_attribute, cached_counter_attribute_name) if has_cached_counter?
  return @target.size if loaded?
  return count
end
</pre>
<p>It&#8217;ll reach the counter_cache column which could be incorrect, giving you all the objects returned when you look up the association, but an invalid number. This was only in my tests where data was being created through Machinist. Just watch yourself for this, this is the second time it has caught me, and ideally the last.</p>
  </body>
</html>